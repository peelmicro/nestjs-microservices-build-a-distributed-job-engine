# NestJS Microservices: Build a Distributed Job Engine Udemy Course (Part 9)

## 12 Setting up the Kubernetes (cont.)

### 12.5. Setting up Products Protobuf

#### 12.5.1. Modify the `grpc` lib to include the `products.proto` document

- We need to create a new protobuf file for the `products` service.

```proto
syntax = "proto3";

package products;

service ProductsService {
  rpc CreateProduct(CreateProductRequest) returns (CreateProductResponse);
}

message CreateProductRequest {
  string name = 1;
  string category = 2;
  float price = 3;
  int32 stock = 4;
  float rating = 5;
  string description = 6;
}

message CreateProductResponse {}
```

- We need to build the TypeScript code from the protobuf file.

```bash
juanpabloperez@jpp-PROX15-AMD:~/Training/microservices/nestjs-microservices-build-a-distributed-job-engine$ nx build grpc

> nx run grpc:generate-ts-proto

> npx protoc --plugin=protoc-gen-ts_proto=../../node_modules/.bin/protoc-gen-ts_proto --ts_proto_out=./src/lib/types/proto ./src/lib/proto/*.proto --ts_proto_opt=nestJs=true --ts_proto_opt=exportCommonSymbols=false


> nx run grpc:build

> webpack-cli build --node-env=production

chunk (runtime: index) index.js (index) 3.26 KiB [entry] [rendered]
chunk (runtime: main) main.js (main) 3.26 KiB [entry] [rendered]
webpack compiled successfully (554c08c23f9c5797)

——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

 NX   Successfully ran target build for project grpc and 1 task it depends on (6s)
```

- We can see the generated code in the `types/proto` folder of the `grpc` library.

> libs/grpc/src/lib/types/proto/products.ts

```typescript
// Code generated by protoc-gen-ts_proto. DO NOT EDIT.
// versions:
//   protoc-gen-ts_proto  v2.6.1
//   protoc               v3.20.3
// source: products.proto

/* eslint-disable */
import { BinaryReader, BinaryWriter } from '@bufbuild/protobuf/wire';
import { type handleUnaryCall, type UntypedServiceImplementation } from '@grpc/grpc-js';
import { GrpcMethod, GrpcStreamMethod } from '@nestjs/microservices';
import { Observable } from 'rxjs';

export interface CreateProductRequest {
  name: string;
  category: string;
  price: number;
  stock: number;
  rating: number;
  description: string;
}

export interface CreateProductResponse {}

function createBaseCreateProductRequest(): CreateProductRequest {
  return { name: '', category: '', price: 0, stock: 0, rating: 0, description: '' };
}

export const CreateProductRequest: MessageFns<CreateProductRequest> = {
  encode(message: CreateProductRequest, writer: BinaryWriter = new BinaryWriter()): BinaryWriter {
    if (message.name !== '') {
      writer.uint32(10).string(message.name);
    }
    if (message.category !== '') {
      writer.uint32(18).string(message.category);
    }
    if (message.price !== 0) {
      writer.uint32(29).float(message.price);
    }
    if (message.stock !== 0) {
      writer.uint32(32).int32(message.stock);
    }
    if (message.rating !== 0) {
      writer.uint32(45).float(message.rating);
    }
    if (message.description !== '') {
      writer.uint32(50).string(message.description);
    }
    return writer;
  },

  decode(input: BinaryReader | Uint8Array, length?: number): CreateProductRequest {
    const reader = input instanceof BinaryReader ? input : new BinaryReader(input);
    let end = length === undefined ? reader.len : reader.pos + length;
    const message = createBaseCreateProductRequest();
    while (reader.pos < end) {
      const tag = reader.uint32();
      switch (tag >>> 3) {
        case 1: {
          if (tag !== 10) {
            break;
          }

          message.name = reader.string();
          continue;
        }
        case 2: {
          if (tag !== 18) {
            break;
          }

          message.category = reader.string();
          continue;
        }
        case 3: {
          if (tag !== 29) {
            break;
          }

          message.price = reader.float();
          continue;
        }
        case 4: {
          if (tag !== 32) {
            break;
          }

          message.stock = reader.int32();
          continue;
        }
        case 5: {
          if (tag !== 45) {
            break;
          }

          message.rating = reader.float();
          continue;
        }
        case 6: {
          if (tag !== 50) {
            break;
          }

          message.description = reader.string();
          continue;
        }
      }
      if ((tag & 7) === 4 || tag === 0) {
        break;
      }
      reader.skip(tag & 7);
    }
    return message;
  },
};

function createBaseCreateProductResponse(): CreateProductResponse {
  return {};
}

export const CreateProductResponse: MessageFns<CreateProductResponse> = {
  encode(_: CreateProductResponse, writer: BinaryWriter = new BinaryWriter()): BinaryWriter {
    return writer;
  },

  decode(input: BinaryReader | Uint8Array, length?: number): CreateProductResponse {
    const reader = input instanceof BinaryReader ? input : new BinaryReader(input);
    let end = length === undefined ? reader.len : reader.pos + length;
    const message = createBaseCreateProductResponse();
    while (reader.pos < end) {
      const tag = reader.uint32();
      switch (tag >>> 3) {
      }
      if ((tag & 7) === 4 || tag === 0) {
        break;
      }
      reader.skip(tag & 7);
    }
    return message;
  },
};

export interface ProductsServiceClient {
  createProduct(request: CreateProductRequest): Observable<CreateProductResponse>;
}

export interface ProductsServiceController {
  createProduct(request: CreateProductRequest): Promise<CreateProductResponse> | Observable<CreateProductResponse> | CreateProductResponse;
}

export function ProductsServiceControllerMethods() {
  return function (constructor: Function) {
    const grpcMethods: string[] = ['createProduct'];
    for (const method of grpcMethods) {
      const descriptor: any = Reflect.getOwnPropertyDescriptor(constructor.prototype, method);
      GrpcMethod('ProductsService', method)(constructor.prototype[method], method, descriptor);
    }
    const grpcStreamMethods: string[] = [];
    for (const method of grpcStreamMethods) {
      const descriptor: any = Reflect.getOwnPropertyDescriptor(constructor.prototype, method);
      GrpcStreamMethod('ProductsService', method)(constructor.prototype[method], method, descriptor);
    }
  };
}

export const PRODUCTS_SERVICE_NAME = 'ProductsService';

export type ProductsServiceService = typeof ProductsServiceService;
export const ProductsServiceService = {
  createProduct: {
    path: '/products.ProductsService/CreateProduct',
    requestStream: false,
    responseStream: false,
    requestSerialize: (value: CreateProductRequest) => Buffer.from(CreateProductRequest.encode(value).finish()),
    requestDeserialize: (value: Buffer) => CreateProductRequest.decode(value),
    responseSerialize: (value: CreateProductResponse) => Buffer.from(CreateProductResponse.encode(value).finish()),
    responseDeserialize: (value: Buffer) => CreateProductResponse.decode(value),
  },
} as const;

export interface ProductsServiceServer extends UntypedServiceImplementation {
  createProduct: handleUnaryCall<CreateProductRequest, CreateProductResponse>;
}

interface MessageFns<T> {
  encode(message: T, writer?: BinaryWriter): BinaryWriter;
  decode(input: BinaryReader | Uint8Array, length?: number): T;
}
```

#### Create a `enum` for the `packages` in the `grpc` library

- We need to create a new enum for the `packages` in the `grpc` library.

> libs/grpc/src/lib/types/packages.ts

```typescript
export enum Packages {
  AUTH = 'auth',
  PRODUCTS = 'products',
}
```

- We need to update the `index.ts` file to include the new `enum`.

> libs/grpc/src/lib/types/index.ts

```typescript
export * from './lib/types/proto';
export * from './lib/interceptors';
export * from './lib/types/packages';
```

- We need to update the `auth main.ts` file to include the new `enum`.

> apps/auth/src/main.ts

```typescript
import 'module-alias/register';
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app/app.module';
import { GrpcOptions, Transport } from '@nestjs/microservices';
import { Packages } from '@jobber/grpc';
import { join } from 'path';
import { init } from '@jobber/nestjs';
import { ConfigService } from '@nestjs/config';

async function bootstrap() {
  const app = await NestFactory.create(AppModule, { bufferLogs: true });
  await init(app);
  app.connectMicroservice<GrpcOptions>({
    transport: Transport.GRPC,
    options: {
      url: app.get(ConfigService).getOrThrow('AUTH_GRPC_SERVICE_URL'),
      package: Packages.AUTH,
      protoPath: join(__dirname, '../../libs/grpc/proto/auth.proto'),
    },
  });
  await app.startAllMicroservices();
}

bootstrap();
```

- We need to update the `jobs module.ts` file to include the new `enum`.

> apps/jobs/src/app/jobs.module.ts

```typescript
import { Module } from '@nestjs/common';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { FibonacciJob } from './jobs/fibonacci/fibonacci.job';
import { DiscoveryModule } from '@golevelup/nestjs-discovery';
import { JobsService } from './jobs.service';
import { JobsResolver } from './jobs.resolver';
import { ClientsModule, Transport } from '@nestjs/microservices';
import { Packages } from '@jobber/grpc';
import { join } from 'path';
import { PulsarModule } from '@jobber/pulsar';

@Module({
  imports: [
    ConfigModule,
    DiscoveryModule,
    PulsarModule,
    ClientsModule.registerAsync([
      {
        name: Packages.AUTH,
        useFactory: (configService: ConfigService) => ({
          transport: Transport.GRPC,
          options: {
            url: configService.getOrThrow('AUTH_GRPC_SERVICE_URL'),
            package: Packages.AUTH,
            protoPath: join(__dirname, '../../libs/grpc/proto/auth.proto'),
          },
        }),
        inject: [ConfigService],
      },
    ]),
  ],
  controllers: [],
  providers: [FibonacciJob, JobsService, JobsResolver],
})
export class JobsModule {}
```

- We need to update the `GqlAuthGuard` guard to include the new `enum`.

> libs/graphql/src/lib/guards/gql-auth.guard.ts

```typescript
import { CanActivate, ExecutionContext, Inject, Injectable, Logger, OnModuleInit } from '@nestjs/common';

import { catchError, map, Observable, of } from 'rxjs';
import { ClientGrpc } from '@nestjs/microservices';
import { GqlExecutionContext } from '@nestjs/graphql';
import { Packages, AUTH_SERVICE_NAME, AuthServiceClient } from '@jobber/grpc';

@Injectable()
export class GqlAuthGuard implements CanActivate, OnModuleInit {
  private readonly logger = new Logger(GqlAuthGuard.name);
  private authService: AuthServiceClient;

  constructor(@Inject(Packages.AUTH) private client: ClientGrpc) {}

  onModuleInit() {
    this.authService = this.client.getService<AuthServiceClient>(AUTH_SERVICE_NAME);
  }

  canActivate(context: ExecutionContext): boolean | Promise<boolean> | Observable<boolean> {
    const token = this.getRequest(context).cookies?.Authentication;

    if (!token) {
      return false;
    }

    return this.authService.authenticate({ token }).pipe(
      map((res) => {
        this.getRequest(context).user = res;
        return true;
      }),
      catchError((err) => {
        this.logger.error(err);
        return of(false);
      }),
    );
  }

  private getRequest(context: ExecutionContext) {
    const ctx = GqlExecutionContext.create(context);
    return ctx.getContext().req;
  }
}
```

### 12.6 Setting the `products gRPC` microservice inside the `products main.ts` document

- We need to update the `.env` file to include the `AUTH_GRPC_SERVICE_URL` environment variable.

> apps/products/.env

```
PORT=3003
DATABASE_URL=postgresql://postgres:example@localhost:5432/products?schema=public
PRODUCTS_GRPC_SERVICE_URL=localhost:5001
```

- We need to update the `products main.ts` file to include the `products gRPC` microservice.

> apps/products/src/main.ts

```typescript
require('module-alias/register');
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app/app.module';
import { init } from '@jobber/nestjs';
import { GrpcOptions, Transport } from '@nestjs/microservices';
import { ConfigService } from '@nestjs/config';
import { Packages } from '@jobber/grpc';
import { join } from 'path';

async function bootstrap() {
  const app = await NestFactory.create(AppModule, { bufferLogs: true });
  await init(app);
  app.connectMicroservice<GrpcOptions>({
    transport: Transport.GRPC,
    options: {
      url: app.get(ConfigService).getOrThrow('PRODUCTS_GRPC_SERVICE_URL'),
      package: Packages.PRODUCTS,
      protoPath: join(__dirname, '../../libs/grpc/proto/products.proto'),
    },
  });
  await app.startAllMicroservices();
}

bootstrap();
```

- We need to ensure that the products service is correctly started.

```bash
juanpabloperez@jpp-PROX15-AMD:~/Training/microservices/nestjs-microservices-build-a-distributed-job-engine$ nx serve products

 NX   Running target serve for project products and 4 tasks it depends on:

————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

> nx run grpc:generate-ts-proto

> npx protoc --plugin=protoc-gen-ts_proto=../../node_modules/.bin/protoc-gen-ts_proto --ts_proto_out=./src/lib/types/proto --proto_path=./src/lib/proto src/lib/proto/*.proto --ts_proto_opt=nestJs=true --ts_proto_opt=exportCommonSymbols=false --ts_proto_opt=outputServices=grpc-js


> nx run nestjs:build

> webpack-cli build --node-env=production

chunk (runtime: index) index.js (index) 2.58 KiB [entry] [rendered]
chunk (runtime: main) main.js (main) 2.58 KiB [entry] [rendered]
webpack compiled successfully (09c76bbd450379d5)

> nx run grpc:build

> webpack-cli build --node-env=production

chunk (runtime: index) index.js (index) 11.7 KiB [entry] [rendered]
chunk (runtime: main) main.js (main) 11.7 KiB [entry] [rendered]
webpack compiled successfully (82d4a6e9a497efa3)

> nx run products:build

> webpack-cli build node-env=production

chunk (runtime: main) main.js (main) 8.78 KiB [entry] [rendered]
webpack compiled successfully (ed63c12b7a45bd51)

> nx run products:serve:development


 NX   Running target build for project products and 3 tasks it depends on:

————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

> nx run grpc:generate-ts-proto  [existing outputs match the cache, left as is]


> nx run nestjs:build  [existing outputs match the cache, left as is]


> nx run grpc:build  [existing outputs match the cache, left as is]


> nx run products:build:development

> webpack-cli build node-env=development

chunk (runtime: main) main.js (main) 8.78 KiB [entry] [rendered]
webpack compiled successfully (ed63c12b7a45bd51)

————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

 NX   Successfully ran target build for project products and 3 tasks it depends on

Nx read the output from the cache instead of running the command for 3 out of 4 tasks.

Debugger listening on ws://localhost:9229/46387eae-0a78-44d3-831b-7a4f23269727
For help, see: https://nodejs.org/en/docs/inspector

[06:17:41.265] INFO (175022): Starting Nest application... {"context":"NestFactory"}
[06:17:41.265] INFO (175022): AppModule dependencies initialized {"context":"InstanceLoader"}
[06:17:41.265] INFO (175022): LoggerModule dependencies initialized {"context":"InstanceLoader"}
[06:17:41.265] INFO (175022): ConfigHostModule dependencies initialized {"context":"InstanceLoader"}
[06:17:41.265] INFO (175022): ConfigModule dependencies initialized {"context":"InstanceLoader"}
[06:17:41.265] INFO (175022): DatabaseModule dependencies initialized {"context":"InstanceLoader"}
[06:17:41.265] INFO (175022): ProductsModule dependencies initialized {"context":"InstanceLoader"}
[06:17:41.265] INFO (175022): LoggerModule dependencies initialized {"context":"InstanceLoader"}
[06:17:41.265] WARN (175022): Unsupported route path: "/api/*". In previous versions, the symbols ?, *, and + were used to denote optional or repeating path parameters. The latest version of "path-to-regexp" now requires the use of named parameters. For example, instead of using a route like /users/* to capture all routes starting with "/users", you should use /users/*path. For more details, refer to the migration guide. Attempting to auto-convert... {"context":"LegacyRouteConverter"}
[06:17:41.265] WARN (175022): Unsupported route path: "/api/*". In previous versions, the symbols ?, *, and + were used to denote optional or repeating path parameters. The latest version of "path-to-regexp" now requires the use of named parameters. For example, instead of using a route like /users/* to capture all routes starting with "/users", you should use /users/*path. For more details, refer to the migration guide. Attempting to auto-convert... {"context":"LegacyRouteConverter"}
[06:17:41.265] INFO (175022): Nest application successfully started {"context":"NestApplication"}
[06:17:41.265] INFO (175022): 🚀 Application is running on: http://localhost:3003/api
[06:17:41.325] INFO (175022): Nest microservice successfully started {"context":"NestMicroservice"}
```

- We need to create the `products.controller.ts` file.

> apps/products/src/app/products/products.controller.ts

```typescript
import { CreateProductRequest, GrpcLoggingInterceptor, ProductsServiceController, ProductsServiceControllerMethods } from '@jobber/grpc';
import { Controller, UseInterceptors } from '@nestjs/common';
import { ProductsService } from './products.service';

@Controller()
@ProductsServiceControllerMethods()
@UseInterceptors(GrpcLoggingInterceptor)
export class ProductsController implements ProductsServiceController {
  constructor(private readonly productsService: ProductsService) {}

  createProduct(request: CreateProductRequest) {
    return this.productsService.createProduct(request);
  }
}
```

### 12.7. Setting up the `products` job inside the `jobs` service

- The same that we did for the `Fibonacci` job, we need to create a new job for the `Products` in the `jobs` service.

#### 12.7.1. Create the `load-products.message.ts` file

> libs/pulsar/src/lib/messages/load-products.message.ts

```typescript
import { IsInt, IsNotEmpty, IsNumber, IsString, Max, Min } from 'class-validator';
import { JobMessage } from './job.message';

export class LoadProductsMessage extends JobMessage {
  @IsString()
  @IsNotEmpty()
  name: string | undefined;

  @IsString()
  @IsNotEmpty()
  category: string | undefined;

  @IsNumber()
  @Min(0)
  price: number | undefined;

  @IsInt()
  @Min(0)
  stock: number | undefined;

  @IsNumber()
  @Min(0)
  @Max(5)
  rating: number | undefined;

  @IsString()
  @IsNotEmpty()
  description: string | undefined;
}
```

#### 12.7.2. Create the `load-products.job.ts` file

> apps/jobs/src/app/jobs/products/load-products.job.ts

```typescript
import { Jobs } from '@jobber/nestjs';
import { Job } from '../../decorators/job.decorator';
import { AbstractJob } from '../abstract.job';
import { LoadProductsMessage, PulsarClient } from '@jobber/pulsar';
// import { PrismaService } from '../../prisma/prisma.service';

@Job({
  name: Jobs.LOAD_PRODUCTS,
  description: 'Loads uploaded product data into the DB after enrichment.',
})
export class LoadProductsJob extends AbstractJob<LoadProductsMessage> {
  protected messageClass = LoadProductsMessage;

  constructor(
    pulsarClient: PulsarClient,
    // prismaService: PrismaService
  ) {
    super(
      pulsarClient,
      // prismaService
    );
  }
}
```

#### 12.7.3. Update the `jobs.module.ts` file

> apps/jobs/src/app/jobs.module.ts

```typescript
import { Module } from '@nestjs/common';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { FibonacciJob } from './jobs/fibonacci/fibonacci.job';
import { DiscoveryModule } from '@golevelup/nestjs-discovery';
import { JobsService } from './jobs.service';
import { JobsResolver } from './jobs.resolver';
import { ClientsModule, Transport } from '@nestjs/microservices';
import { Packages } from '@jobber/grpc';
import { join } from 'path';
import { PulsarModule } from '@jobber/pulsar';
import { LoadProductsJob } from './jobs/products/load-products.job';

@Module({
  imports: [
    ConfigModule,
    DiscoveryModule,
    PulsarModule,
    ClientsModule.registerAsync([
      {
        name: Packages.AUTH,
        useFactory: (configService: ConfigService) => ({
          transport: Transport.GRPC,
          options: {
            url: configService.getOrThrow('AUTH_GRPC_SERVICE_URL'),
            package: Packages.AUTH,
            protoPath: join(__dirname, '../../libs/grpc/proto/auth.proto'),
          },
        }),
        inject: [ConfigService],
      },
    ]),
  ],
  controllers: [],
  providers: [FibonacciJob, JobsService, JobsResolver, LoadProductsJob],
})
export class JobsModule {}
```

### 12.8 Modify the `abstract.job.ts` file to make it work asynchronously

> apps/jobs/src/app/job.http

```typescript
import { Producer } from 'pulsar-client';
import { PulsarClient, serialize } from '@jobber/pulsar';
import { plainToInstance } from 'class-transformer';
import { validate } from 'class-validator';
import { BadRequestException } from '@nestjs/common';
export abstract class AbstractJob<T extends object> {
  private producer: Producer;
  protected abstract messageClass: new () => T;

  constructor(private readonly pulsarClient: PulsarClient) {}

  async execute(data: T, name: string) {
    if (!this.producer) {
      this.producer = await this.pulsarClient.createProducer(name);
    }
    if (Array.isArray(data)) {
      for (const message of data) {
        this.send(message);
      }
      return;
    }
    this.send(data);
  }

  private send(data: T) {
    this.validateData(data).then(() => this.producer.send({ data: serialize(data) }));
  }

  private async validateData(data: T) {
    const errors = await validate(plainToInstance(this.messageClass, data));
    if (errors.length) {
      throw new BadRequestException(`Job data is invalid: ${JSON.stringify(errors, null, 2)}`);
    }
  }
}
```

### 12.9 Update the `jobs.service.ts` file to include the `LoadProductsJob`

> apps/jobs/src/app/jobs.service.ts

```typescript
import { DiscoveredClassWithMeta, DiscoveryService } from '@golevelup/nestjs-discovery';
import { BadRequestException, Injectable, InternalServerErrorException, OnModuleInit } from '@nestjs/common';
import { JOB_METADATA_KEY } from './decorators/job.decorator';
import { JobMetadata } from './interfaces/job-metadata.interface';
import { AbstractJob } from './jobs/abstract.job';
import { readFileSync } from 'fs';
import { UPLOAD_FILE_PATH } from './uploads/upload';

@Injectable()
export class JobsService implements OnModuleInit {
  private jobs: DiscoveredClassWithMeta<JobMetadata>[] = [];

  constructor(private readonly discoveryService: DiscoveryService) {}

  async onModuleInit() {
    this.jobs = await this.discoveryService.providersWithMetaAtKey<JobMetadata>(JOB_METADATA_KEY);
    console.log(this.jobs);
  }

  getJobsMetadata() {
    return this.jobs.map((job) => job.meta);
  }

  async executeJob(name: string, data?: any) {
    const job = this.jobs.find((job) => job.meta.name === name);
    if (!job) {
      throw new BadRequestException(`Job with name ${name} not found`);
    }
    if (!(job.discoveredClass.instance instanceof AbstractJob)) {
      throw new InternalServerErrorException('Job is not an instance of AbstractJob.');
    }
    return job.discoveredClass.instance.execute(data?.fileName ? this.getFile(data.fileName) : data || {}, job.meta.name);
  }

  getJobByName(name: string) {
    const job = this.jobs.find((job) => job.meta.name === name);
    if (!job) {
      throw new BadRequestException(`Job with name ${name} not found`);
    }

    // Return a Job object with the metadata
    return {
      name: job.meta.name,
      description: job.meta.description,
    };
  }

  private getFile(fileName?: string) {
    if (!fileName) {
      return;
    }
    try {
      return JSON.parse(readFileSync(`${UPLOAD_FILE_PATH}/${fileName}`, 'utf-8'));
    } catch (err) {
      throw new InternalServerErrorException(`Failed to read file: ${fileName}`);
    }
  }
}
```

### 12.10 Update the `job.http` file to include the `LoadProductsJob`

> apps/jobs/src/app/job.http

```http
@urlLogin = http://localhost:3000/graphql

@urlRest = http://localhost:3001/api
@url = http://localhost:3001/graphql

### Login
# @name login
POST {{urlLogin}}
Content-Type: application/json
X-REQUEST-TYPE: GraphQL

mutation {
  login(loginInput: { email: "my-email2@msn.com", password: "MyPassword2!" }) {
    id
  }
}

### Install httpbin and run using docker with "docker run -p 80:80 kennethreitz/httpbin"
GET http://0.0.0.0:80/anything
Content-Type: application/json
X-Full-Response: {{login.response.body.*}}

### Get jobs metadata
POST {{url}}
Content-Type: application/json
Cookie: {{login.response.headers.Set-Cookie}}
X-REQUEST-TYPE: GraphQL

query {
  jobsMetadata {
    name
    description
  }
}

### Execute Fibonacci job with invalid name
POST {{url}}
Content-Type: application/json
Cookie: {{login.response.headers.Set-Cookie}}
X-REQUEST-TYPE: GraphQL

mutation {
  executeJob(executeJobInput: {name: "Bad"}) {
    name
  }
}

### Execute Fibonacci job with one message
POST {{url}}
Content-Type: application/json
Cookie: {{login.response.headers.Set-Cookie}}
X-REQUEST-TYPE: GraphQL

mutation {
  executeJob(executeJobInput: {name: "Fibonacci", data: {iterations: 40}}) {
    name
  }
}

### Execute Fibonacci job with multiple messages
POST {{url}}
Content-Type: application/json
Cookie: {{login.response.headers.Set-Cookie}}
X-REQUEST-TYPE: GraphQL

mutation {
  executeJob(executeJobInput: {name: "Fibonacci", data: [{iterations: 40}, {iterations: 41}]}) {
    name
  }
}


### Execute Fibonacci job with invalid data
POST {{url}}
Content-Type: application/json
Cookie: {{login.response.headers.Set-Cookie}}
X-REQUEST-TYPE: GraphQL

mutation {
  executeJob(executeJobInput: {name: "Fibonacci", data: {iteration: 40}}) {
    name
  }
}

### Upload file
POST {{urlRest}}/uploads/upload
Content-Type: multipart/form-data ; boundary=MfnBoundry

--MfnBoundry
Content-Disposition: form-data; name="file"; filename="products.json"
Content-Type: application/json

< ./data/products.json

--MfnBoundry--


### Execute Load Products job with one filename
POST {{url}}
Content-Type: application/json
Cookie: {{login.response.headers.Set-Cookie}}
X-REQUEST-TYPE: GraphQL

mutation {
  executeJob(executeJobInput: {name: "LoadProducts", data: {fileName: "file-1742659574274-319632607.json"}}) {
    name
  }
}
```

### 12.11 Test if the new job is working

- When we execute the new request, we should see it works:

> Request:

```http
### Execute Load Products job with one filename
POST {{url}}
Content-Type: application/json
Cookie: {{login.response.headers.Set-Cookie}}
X-REQUEST-TYPE: GraphQL

mutation {
  executeJob(executeJobInput: {name: "LoadProducts", data: {fileName: "file-1742659574274-319632607.json"}}) {
    name
  }
}
```

> Response:

```json
HTTP/1.1 200 OK
X-Powered-By: Express
cache-control: no-store
Content-Type: application/json; charset=utf-8
Content-Length: 48
ETag: W/"30-/M4kLcVyISYwL5nFCGTaXBJBQDM"
Date: Sun, 23 Mar 2025 12:59:45 GMT
Connection: close

{
  "data": {
    "executeJob": {
      "name": "LoadProducts"
    }
  }
}
```

- We can see that the job is executed successfully.

### 12.12 Modify the `executor` service to process the `products` job

#### 12.12.1. Create the `load-products.consumer.ts` file

> apps/executor/src/app/jobs/products/load-products.consumer.ts

```typescript
import { Jobs } from '@jobber/nestjs';
import { LoadProductsMessage, PulsarClient, PulsarConsumer } from '@jobber/pulsar';
import { Injectable, OnModuleInit } from '@nestjs/common';

@Injectable()
export class LoadProductsConsumer extends PulsarConsumer<LoadProductsMessage> implements OnModuleInit {
  constructor(pulsarClient: PulsarClient) {
    super(pulsarClient, Jobs.LOAD_PRODUCTS);
  }

  protected async onMessage(data: LoadProductsMessage): Promise<void> {
    this.logger.log(`LoadProductsConsumer: ${JSON.stringify(data, null, 2)}`);
  }
}
```

#### 12.12.2. Create the `load-products.module.ts` file

> apps/executor/src/app/jobs/products/load-products.module.ts

```typescript
import { Module } from '@nestjs/common';
import { LoadProductsConsumer } from './load-products.consumer';
import { PulsarModule } from '@jobber/pulsar';

@Module({
  imports: [PulsarModule],
  providers: [LoadProductsConsumer],
})
export class LoadProductModule {}
```

#### 12.12.3. Update the `jobs.module.ts` file to include the `LoadProductModule`

> apps/executor/src/app/jobs/jobs.module.ts

```typescript
import { PulsarModule } from '@jobber/pulsar';
import { Module } from '@nestjs/common';
import { FibonacciConsumer } from './fibonacci/fibonacci.consumer';
import { LoadProductModule } from './products/load-products.module';

@Module({
  imports: [PulsarModule, LoadProductModule],
  providers: [FibonacciConsumer],
})
export class JobsModule {}
```

#### 12.12.4 Test if the new job is working

> Request

```http
### Execute Load Products job with one filename
POST {{url}}
Content-Type: application/json
Cookie: {{login.response.headers.Set-Cookie}}
X-REQUEST-TYPE: GraphQL

mutation {
  executeJob(executeJobInput: {name: "LoadProducts", data: {fileName: "file-1742659574274-319632607.json"}}) {
    name
  }
}
```

> Response

```json
HTTP/1.1 200 OK
X-Powered-By: Express
cache-control: no-store
Content-Type: application/json; charset=utf-8
Content-Length: 48
ETag: W/"30-/M4kLcVyISYwL5nFCGTaXBJBQDM"
Date: Sun, 23 Mar 2025 13:43:55 GMT
Connection: close

{
  "data": {
    "executeJob": {
      "name": "LoadProducts"
    }
  }
}
```

- We can see the logs in the `executor` service.

```bash
.
[13:44:02.896] INFO (418525): LoadProductsConsumer: {
  "name": "Smart Watch",
  "category": "Electronics",
  "price": 150.88,
  "stock": 258,
  "rating": 3.5,
  "description": "Track your fitness, receive notifications, and more with this sleek smartwatch."
} {"context":"LoadProducts"}
[13:44:02.897] DEBUG (418525): Received message: {
  "name": "Stainless Steel Water Bottle",
  "category": "Home & Kitchen",
  "price": 247.84,
  "stock": 147,
  "rating": 4.7,
  "description": "Keeps beverages hot or cold for hours, perfect for outdoor activities."
} {"context":"LoadProducts"}
[13:44:02.897] INFO (418525): LoadProductsConsumer: {
  "name": "Stainless Steel Water Bottle",
  "category": "Home & Kitchen",
  "price": 247.84,
  "stock": 147,
  "rating": 4.7,
  "description": "Keeps beverages hot or cold for hours, perfect for outdoor activities."
} {"context":"LoadProducts"}
```

### 12.13 Set up a gRPC client to process the `products` job

#### 12.13.1 Update the `.env` file to include the `PRODUCTS_GRPC_SERVICE_URL`

> apps/executor/.env

```text
PORT=3002
PULSAR_SERVICE_URL=pulsar://localhost:6650
PRODUCTS_GRPC_SERVICE_URL=localhost:5001
```

#### 12.13.2. Update the `load-products.consumer.ts` file

> apps/executor/src/app/jobs/products/load-products.consumer.ts

```typescript
import { Packages, PRODUCTS_SERVICE_NAME, ProductsServiceClient } from '@jobber/grpc';
import { Jobs } from '@jobber/nestjs';
import { LoadProductsMessage, PulsarClient, PulsarConsumer } from '@jobber/pulsar';
import { Inject, Injectable, OnModuleInit } from '@nestjs/common';
import { ClientGrpc } from '@nestjs/microservices';
import { firstValueFrom } from 'rxjs';

@Injectable()
export class LoadProductsConsumer extends PulsarConsumer<LoadProductsMessage> implements OnModuleInit {
  private productsService: ProductsServiceClient;

  constructor(
    pulsarClient: PulsarClient,
    @Inject(Packages.PRODUCTS) private clientProducts: ClientGrpc,
  ) {
    super(pulsarClient, Jobs.LOAD_PRODUCTS);
  }

  async onModuleInit() {
    this.productsService = this.clientProducts.getService<ProductsServiceClient>(PRODUCTS_SERVICE_NAME);
    await super.onModuleInit();
  }

  protected async onMessage(data: LoadProductsMessage): Promise<void> {
    await firstValueFrom(this.productsService.createProduct(data));
  }
}
```

#### 12.13.3. Update the `load-products.module.ts` file

> apps/executor/src/app/jobs/products/load-products.module.ts

```typescript
import { Module } from '@nestjs/common';
import { LoadProductsConsumer } from './load-products.consumer';
import { PulsarModule } from '@jobber/pulsar';
import { ClientsModule, Transport } from '@nestjs/microservices';
import { Packages } from '@jobber/grpc';
import { ConfigService } from '@nestjs/config';
import { join } from 'path';

@Module({
  imports: [
    PulsarModule,
    ClientsModule.registerAsync([
      {
        name: Packages.PRODUCTS,
        useFactory: (configService: ConfigService) => ({
          transport: Transport.GRPC,
          options: {
            url: configService.getOrThrow('PRODUCTS_GRPC_SERVICE_URL'),
            package: Packages.PRODUCTS,
            protoPath: join(__dirname, '../../libs/grpc/proto/products.proto'),
          },
        }),
        inject: [ConfigService],
      },
    ]),
  ],
  providers: [LoadProductsConsumer],
})
export class LoadProductModule {}
```

#### 12.13.4. Test if the new job is working

- Executing the request again, we should see the logs in the `executor` service.

```bash

[14:46:50.501] DEBUG (508683): Received message: {
  "name": "Portable Charger",
  "category": "Electronics",
  "price": 249.81,
  "stock": 182,
  "rating": 3.6,
  "description": "Compact and powerful portable charger for your devices on the go."
} {"context":"LoadProducts"}
[14:46:50.502] INFO (508684): {"context":"GrpcLoggingInterceptor","requestId":"1b1841d0-ec0e-4226-aae7-62b3d9a7b534","handler":"createProduct","args":{"name":"Portable Charger","category":"Electronics","price":249.80999755859375,"stock":182,"rating":3.5999999046325684,"description":"Compact and powerful portable charger for your devices on the go."}}
.
```

- We can see the database has been updated.

![products table](images037.png)

### 12.14 Creating the new `categories` table

- We will create a new table to store the categories of the products.
- And we will modify the `products` table to include the category id.

#### 12.14.1. Create the `categories` schema

> apps/products/src/app/categories/schema.ts

```typescript
import { integer, pgTable, serial, text } from 'drizzle-orm/pg-core';

export const categories = pgTable('categories', {
  id: serial('id').primaryKey(),
  name: text('name').unique(),
  charge: integer('charge'),
});
```

#### 12.14.2. Create the `categories` service

> apps/products/src/app/categories/categories.service.ts

```typescript
import { Inject, Injectable } from '@nestjs/common';
import { DATABASE_CONNECTION } from '../database/database-connection';
import { NodePgDatabase } from 'drizzle-orm/node-postgres';
import * as schema from './schema';
import { eq } from 'drizzle-orm';

@Injectable()
export class CategoriesService {
  constructor(
    @Inject(DATABASE_CONNECTION)
    private readonly database: NodePgDatabase<typeof schema>,
  ) {}

  async getCategoryByName(name: string) {
    return this.database.query.categories.findFirst({
      where: eq(schema.categories.name, name),
    });
  }
}
```

#### 12.14.3. Create the `categories` module

> apps/products/src/app/categories/categories.module.ts

```typescript
import { Module } from '@nestjs/common';
import { CategoriesService } from './categories.service';

@Module({
  providers: [CategoriesService],
  exports: [CategoriesService],
})
export class CategoriesModule {}
```

#### 12.14.4. Update the `database` module to include the `categories` module

> apps/products/src/app/database/database.module.ts

```typescript
import { Global, Module } from '@nestjs/common';
import { DATABASE_CONNECTION } from './database-connection';
import { Pool } from 'pg';
import { drizzle } from 'drizzle-orm/node-postgres';
import * as productsSchema from '../products/schema';
import * as categoriesSchema from '../categories/schema';
import { ConfigService } from '@nestjs/config';

@Global()
@Module({
  providers: [
    {
      provide: DATABASE_CONNECTION,
      useFactory: (configService: ConfigService) => {
        const pool = new Pool({
          connectionString: configService.getOrThrow('DATABASE_URL'),
        });
        return drizzle(pool, {
          schema: {
            ...productsSchema,
            ...categoriesSchema,
          },
        });
      },
      inject: [ConfigService],
    },
  ],
  exports: [DATABASE_CONNECTION],
})
export class DatabaseModule {}
```

#### 12.14.5. Update the `products` module to include the `categories` module

> apps/products/src/app/products/products.module.ts

```typescript
import { Module } from '@nestjs/common';
import { ProductsService } from './products.service';
import { ProductsController } from './products.controller';
import { CategoriesModule } from '../categories/categories.module';

@Module({
  imports: [CategoriesModule],
  controllers: [ProductsController],
  providers: [ProductsService],
})
export class ProductsModule {}
```

#### 12.14.6. Update the `products` service to include the `categories` service

> apps/products/src/app/products/products.service.ts

```typescript
import { Inject, Injectable } from '@nestjs/common';
import { NodePgDatabase } from 'drizzle-orm/node-postgres';
import * as schema from './schema';
import { DATABASE_CONNECTION } from '../database/database-connection';
import { CategoriesService } from '../categories/categories.service';

@Injectable()
export class ProductsService {
  constructor(
    @Inject(DATABASE_CONNECTION)
    private readonly database: NodePgDatabase<typeof schema>,
    private readonly categoriesService: CategoriesService,
  ) {}

  async createProduct(product: Omit<typeof schema.products.$inferSelect, 'id'>) {
    const category = await this.categoriesService.getCategoryByName(product.category);
    await this.database.insert(schema.products).values({
      ...product,
      price: category ? product.price + category.charge : product.price,
    });
  }
}
```

#### 12.14.7. Create a pg script to create the `categories` table by using `nx generate-drizzle products` service

```bash
juanpabloperez@jpp-PROX15-AMD:~/Training/microservices/nestjs-microservices-build-a-distributed-job-engine$ nx generate-drizzle products

> nx run products:generate-drizzle

> drizzle-kit generate

No config path provided, using default 'drizzle.config.ts'
Reading config file '/home/juanpabloperez/Training/microservices/nestjs-microservices-build-a-distributed-job-engine/apps/products/drizzle.config.ts'
2 tables
categories 3 columns 0 indexes 0 fks
products 7 columns 0 indexes 0 fks

[✓] Your SQL migration file ➜ drizzle/0001_organic_galactus.sql 🚀

——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

 NX   Successfully ran target generate-drizzle for project products (706ms)
```

#### 12.14.8. Execute the pg script to create the `categories` table by using `nx migrate-drizzle products` service

```bash
juanpabloperez@jpp-PROX15-AMD:~/Training/microservices/nestjs-microservices-build-a-distributed-job-engine$ nx migrate-drizzle products

> nx run products:migrate-drizzle

> drizzle-kit migrate

No config path provided, using default 'drizzle.config.ts'
Reading config file '/home/juanpabloperez/Training/microservices/nestjs-microservices-build-a-distributed-job-engine/apps/products/drizzle.config.ts'
Using 'pg' driver for database querying
[✓] migrations applied successfully!
——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

 NX   Successfully ran target migrate-drizzle for project products
```

- We can see the `categories` table has been created.

![categories table](images038.png)

#### 12.14.9. Add new categories to the `categories` table by using `drizzle-kit generate`

```bash
juanpabloperez@jpp-PROX15-AMD:~/Training/microservices/nestjs-microservices-build-a-distributed-job-engine/apps/products$ npx drizzle-kit generate --custom --name=seed-categories
No config path provided, using default 'drizzle.config.ts'
Reading config file '/home/juanpabloperez/Training/microservices/nestjs-microservices-build-a-distributed-job-engine/apps/products/drizzle.config.ts'
Prepared empty file for your custom SQL migration!
[✓] Your SQL migration file ➜ drizzle/0002_seed-categories.sql
```

- We can populate the `0002_seed-categories.sql` file with the following data:

> apps/products/drizzle/0002_seed-categories.sql

```sql
-- Custom SQL migration file, put your code below! --
INSERT INTO categories (name, charge) VALUES
  ('Electronics', 5),
  ('Apparel', 3),
  ('Home & Kitchen', 4),
  ('Grocery', 2),
  ('Furniture', 6),
  ('Sports & Outdoors', 4),
  ('Health & Beauty', 3),
  ('Office Supplies', 4),
  ('Toys & Games', 3)
ON CONFLICT (name) DO NOTHING;
```

#### 12.14.10. Execute the pg script to create the `categories` table by using `nx migrate-drizzle products` service

```bash
juanpabloperez@jpp-PROX15-AMD:~/Training/microservices/nestjs-microservices-build-a-distributed-job-engine$ nx migrate-drizzle products

> nx run products:migrate-drizzle

> drizzle-kit migrate

No config path provided, using default 'drizzle.config.ts'
Reading config file '/home/juanpabloperez/Training/microservices/nestjs-microservices-build-a-distributed-job-engine/apps/products/drizzle.config.ts'
Using 'pg' driver for database querying
[✓] migrations applied successfully!
——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

 NX   Successfully ran target migrate-drizzle for project products (480ms)
```

- We can see the `categories` table has been populated with the following data:

![categories table](images039.png)

### 12.15 Creating the `Products Dockerfile` document

#### 12.15.1. We are going to create the `Dockerfile` file

> apps/products/Dockerfile

```dockerfile
# Builder Stage
FROM node:22-slim AS builder

WORKDIR /workspace

# Copy necessary files for building the app
COPY package*.json ./
COPY nx.json ./
COPY tsconfig*.json ./
COPY jest.config.ts ./
COPY jest.preset.js ./
COPY eslint.config.mjs ./
COPY webpack.*.config.js ./

COPY apps/products ./apps/products
COPY libs/grpc ./libs/grpc
COPY libs/nestjs ./libs/nestjs

# Install dependencies
RUN npm install --legacy-peer-deps

RUN apt-get update && apt-get install -y protobuf-compiler

# Build the app
RUN npx nx build products

# Runner Stage
FROM node:22-slim AS runner

WORKDIR /app

# Copy necessary files
COPY --from=builder /workspace/package.json ./
COPY --from=builder /workspace/apps/products/package.json ./apps/products/package.json
COPY --from=builder /workspace/libs/grpc/package.json ./libs/grpc/package.json
COPY --from=builder /workspace/apps/products/drizzle.config.ts ./apps/products/drizzle.config.ts
COPY --from=builder /workspace/apps/products/drizzle ./apps/products/drizzle
COPY --from=builder /workspace/package-lock.json ./

# Set production environment
ENV NODE_ENV=production

# Install production dependencies
RUN npm ci --legacy-peer-deps

# Copy build output and other files
COPY --from=builder /workspace/dist ./dist

# Run the application
CMD ["node", "dist/apps/products/main"]
```

#### 12.15.2. We are going to build the `Products Dockerfile` to ensure the Dockerfile is correct

```bash
juanpabloperez@jpp-PROX15-AMD:~/Training/microservices/nestjs-microservices-build-a-distributed-job-engine$ docker build -t products -f apps/products/Dockerfile .
[+] Building 64.5s (29/29) FINISHED                                                                                                                 docker:default
 => [internal] load build definition from Dockerfile                                                                                                          0.0s
 => => transferring dockerfile: 1.35kB                                                                                                                        0.0s
 => [internal] load metadata for docker.io/library/node:22-slim                                                                                               0.6s
 => [internal] load .dockerignore                                                                                                                             0.0s
 => => transferring context: 57B                                                                                                                              0.0s
 => [builder  1/15] FROM docker.io/library/node:22-slim@sha256:bac8ff0b5302b06924a5e288fb4ceecef9c8bb0bb92515985d2efdc3a2447052                               6.6s
 => => resolve docker.io/library/node:22-slim@sha256:bac8ff0b5302b06924a5e288fb4ceecef9c8bb0bb92515985d2efdc3a2447052                                         0.0s
 => => sha256:6e909acdb790c5a1989d9cfc795fda5a246ad6664bb27b5c688e2b734b2c5fad 28.20MB / 28.20MB                                                              3.2s
 => => sha256:d714f4673cad3750083007b710a3d74ea21d34db71daaa04e44bafafb9d58445 3.31kB / 3.31kB                                                                0.4s
 => => sha256:be84add755f800c3580c34f5f0e56856b96013886d9bfd3f08b0f0d957b77466 48.31MB / 48.31MB                                                              3.4s
 => => sha256:bac8ff0b5302b06924a5e288fb4ceecef9c8bb0bb92515985d2efdc3a2447052 6.49kB / 6.49kB                                                                0.0s
 => => sha256:483b3a6c706e268e57920ab906f72564ecb1dbc715607aa9b26cfa2a43d6e65d 1.93kB / 1.93kB                                                                0.0s
 => => sha256:deef14d1e279853b37d4334712a0fc0a94c8832862c6db075d54f644d60bdbbc 6.54kB / 6.54kB                                                                0.0s
 => => sha256:9a8d89ceeab1eb03867d4edc7c38bf07c9277acb361a5973c71c00fb4d222901 1.71MB / 1.71MB                                                                1.0s
 => => sha256:4c07c1809c8eebaab536b60272897848a5b72b4451b9e51bc7118d5aef302f75 448B / 448B                                                                    1.3s
 => => extracting sha256:6e909acdb790c5a1989d9cfc795fda5a246ad6664bb27b5c688e2b734b2c5fad                                                                     1.1s
 => => extracting sha256:d714f4673cad3750083007b710a3d74ea21d34db71daaa04e44bafafb9d58445                                                                     0.0s
 => => extracting sha256:be84add755f800c3580c34f5f0e56856b96013886d9bfd3f08b0f0d957b77466                                                                     1.9s
 => => extracting sha256:9a8d89ceeab1eb03867d4edc7c38bf07c9277acb361a5973c71c00fb4d222901                                                                     0.1s
 => => extracting sha256:4c07c1809c8eebaab536b60272897848a5b72b4451b9e51bc7118d5aef302f75                                                                     0.0s
 => [internal] load build context                                                                                                                             0.0s
 => => transferring context: 6.18kB                                                                                                                           0.0s
 => [builder  2/15] WORKDIR /workspace                                                                                                                        0.2s
 => [runner  2/10] WORKDIR /app                                                                                                                               0.3s
 => [builder  3/15] COPY package*.json ./                                                                                                                     0.0s
 => [builder  4/15] COPY nx.json ./                                                                                                                           0.0s
 => [builder  5/15] COPY tsconfig*.json ./                                                                                                                    0.0s
 => [builder  6/15] COPY jest.config.ts ./                                                                                                                    0.0s
 => [builder  7/15] COPY jest.preset.js ./                                                                                                                    0.0s
 => [builder  8/15] COPY eslint.config.mjs ./                                                                                                                 0.0s
 => [builder  9/15] COPY webpack.*.config.js ./                                                                                                               0.0s
 => [builder 10/15] COPY apps/products ./apps/products                                                                                                        0.0s
 => [builder 11/15] COPY libs/grpc ./libs/grpc                                                                                                                0.0s
 => [builder 12/15] COPY libs/nestjs ./libs/nestjs                                                                                                            0.0s
 => [builder 13/15] RUN npm install --legacy-peer-deps                                                                                                       18.1s
 => [builder 14/15] RUN apt-get update && apt-get install -y protobuf-compiler                                                                                9.9s
 => [builder 15/15] RUN npx nx build products                                                                                                                16.0s
 => [runner  3/10] COPY --from=builder /workspace/package.json ./                                                                                             0.1s
 => [runner  4/10] COPY --from=builder /workspace/apps/products/package.json ./apps/products/package.json                                                     0.0s
 => [runner  5/10] COPY --from=builder /workspace/libs/grpc/package.json ./libs/grpc/package.json                                                             0.0s
 => [runner  6/10] COPY --from=builder /workspace/apps/products/drizzle.config.ts ./apps/products/drizzle.config.ts                                           0.0s
 => [runner  7/10] COPY --from=builder /workspace/apps/products/drizzle ./apps/products/drizzle                                                               0.0s
 => [runner  8/10] COPY --from=builder /workspace/package-lock.json ./                                                                                        0.0s
 => [runner  9/10] RUN npm ci --legacy-peer-deps                                                                                                              9.4s
 => [runner 10/10] COPY --from=builder /workspace/dist ./dist                                                                                                 0.0s
 => exporting to image                                                                                                                                        2.0s
 => => exporting layers                                                                                                                                       2.0s
 => => writing image sha256:077414326bd8533ffd10806a200539169f16e9a8db3ddc8cd128c08fdf7af3ac                                                                  0.0s
 => => naming to docker.io/library/products
```

#### 12.15.3. We are going to modify the `Elastic Container Registry (ECR)` to include the `products` image

![Create Repository](images039.png)

![Put the name of the repository](images040.png)

![Ensure it has been created](images041.png)

#### 12.15.4 Modify the Github Actions to include the `products` image

> .github/workflows/ci.yml

```diff
.
      - name: Build and push all images to ECR
        run: |
          IMAGES=(
            "jobs apps/jobs/Dockerfile"
            "executor apps/executor/Dockerfile"
            "auth apps/auth/Dockerfile"
+           "products apps/products/Dockerfile"
          )
.
```

#### 12.15.5 We are going to modify the `Products wepack.config.js` file to use the `commonConfig` file

> apps/products/webpack.config.js

```js
const { join } = require('path');
const { merge } = require('webpack-merge');
const commonConfig = require('../../webpack.app.config');

module.exports = merge(commonConfig, {
  output: {
    path: join(__dirname, '../../dist/apps/products'),
  },
});
```
